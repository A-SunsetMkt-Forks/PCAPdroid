## 3.1 Introduction

PCAPdroid has the ability to decrypt the TLS traffic and display the decrypted payload directly into the app. Moreover, when dumping traffic to PCAP, it generates a `SSLKEYLOGFILE`, containing the decryption secrets, which can be loaded into other apps like Wireshark [to decrypt](https://wiki.wireshark.org/TLS#tls-decryption) the generated PCAP file.

Most apps today employ TLS to secure their data against inspection and tampering. Such connections are reported in PCAPdroid with either the TLS or the HTTPS protocol. Decryption can be useful in the following contexts:

- Check if an app sends out sensitive information or unhashed passwords
- Analyze the security of an app, e.g. to check if it employs certificate pinning
- Debug protocol-related issues without disabling encryption on the transport
- Reverse engineer the protocol of an app, e.g. to to extract the REST API endpoints

**Note**: before decrypting, you should check the app terms-of-service to see if this is allowed

**Note**: running TLS decryption will weaken the security of your app. Only do this if you know what you are doing and for limited amount of time

Current limitations:

- TLS decryption is not available with the root capture
- Decrypting QUIC traffic [it not supported yet](https://github.com/mitmproxy/mitmproxy/issues/4170)
- Decrypting STARTTLS [it not supported yet](https://github.com/mitmproxy/mitmproxy/issues/4215)

TLS decryption on Android is not an easy task, technical knowledge and familiarity with the topic is required. There are many pitfalls and limitations which are be discussed below. A rooted device will help you to be successful in most circumstances.


## 3.2 Initial setup

TLS decryption can be enabled from the PCAPdroid settings. The first time decryption is enabled, a setup wizard will help you properly setting up decrypyion. It includes the following steps:

1. Download and installation of the [PCAPdroid-mitm addon](https://github.com/emanuele-f/PCAPdroid-mitm). The actual decryption is performed by [mitmproxy](https://github.com/mitmproxy/mitmproxy), which is bundled into the addon. Please note the addon is build using the closed source tool [chaquopy](https://chaquo.com/chaquopy)
2. Permission to control the mitm addon. This is a security measure to prevent other apps from controlling the addon
3. Installation of the PCAPdroid [CA certificate](https://docs.mitmproxy.org/stable/concepts-certificates). The CA certificate is what allows PCAPdroid to decrypt the app data, and to do so, it must first be added to the certificate store. To increase security, a unique CA certificate is generated by PCAPdroid on your device

Before proceeding, check if your device has [Autostart](https://www.vivo.com/en/support/questionByTitle?title=How%20to%20turn%20on/off%20Autostart%20for%20my%20apps) or similar software which prevents background services excecution, in which case you will need to whitelist the mitm addon, otherwise decryption will refuse to start. After that, the device should be ready to perform decryption.


## 3.3 Decrypting

Before starting the decryption, you will need to select a target app. In fact, decryption is an invasive operation which can break the connectivity of some apps due to certificate trust problems, so it's a good practice to only limit it to a single app.

The first test you should do to verify that decryption works is to choose an app which is easy to decrypt. It turns out Google Chrome is a good candidate. Enable decryption, select Google Chrome as the target app and then start the capture in PCAPdroid. In chrome, open a new tab and a new HTTPS website (or just clear the browser cache) and you should start seeing decrypted connections in PCAPdroid, marked with a green open lock.

The lock icon and color indicates the decryption status, which is also reported into the connection details:

- *geen*: decryption successful
- *red*: decryption failed. If you tap on the connection, you should get an error message explaining why it failed
- *orange*: decryption is not supported for this protocol/app (e.g. for QUIC and some specific apps, see below)
- *gray open lock*: the connection is not encrypted (e.g. plain DNS)
- *gray closed lock*: decryption not available yet (e.g. waiting for application data)

You can easily show decrypted or decryption-failed connections via the "Edit Filter" dialog under the filter icon.
If you tap on a decrypted connection, the payload and the HTTP tabs will show the decrypted payload data.


## 3.4 Pitfalls and possible solutions

Google chrome is a relatively easy app to decrypt. If you try to decrypt other apps you will soon face some problems, which can mostly addressed with a rooted device and the right tools.

### 3.4.1 The client does not trust the mitm certificate

This decryption error may occur for different reasons:

- Android > 7 and target SDK > 23
- App uses a custom trust store
- [Certificate pinning](https://developer.android.com/training/articles/security-ssl#Pinning) enabled on the app

If you are on Android 7 and newer and the app you are decrypting has target SDK > 23, which is usually the case, then the problem is that since Android 7 apps don't trust user certificates anymore, so the target app is not accepting the mitm certificate. In order to overcome this issue, you either need to:

- If you have the app source code and can build the app, refer to the [the Android guide](https://developer.android.com/training/articles/security-config.html) to trust the PCAPdroid CA
- On a device rooted with magisk, you can install the [MagiskTrustUserCerts plugin](https://github.com/NVISOsecurity/MagiskTrustUserCerts), which adds the user certs to the system store via a filesystem overlay. This is the suggested solution if you have magisk
- On any rooted device, you can install the certificate [into the system store](https://docs.mitmproxy.org/stable/howto-install-system-trusted-ca-android/#3-insert-certificate-into-system-certificate-store), by mounting the system partition as rw
- You can use [apktool](https://ibotpeaches.github.io/Apktool) to decompile the app, lower its target SDK to 23, and rebuild it
- You can use [VirtualXposed](https://github.com/android-hacker/VirtualXposed) to virtualize your app, making it run as it was SDK 23. To do so, open VirtualXposed, select "Add App" and install the target application that you want to decrypt (use the "virtualxposed" method). Then in PCAPdroid, select VirtualXposed as the target app for the decryption. Virtualization is quite unreliable, so expect crashes

Additionally, some apps (mainly browsers) implement a custom trust store, which is separate from the system store. You should check if they have an option to disable it, for example, in Firefox [you can do this](https://support.mozilla.org/en-US/questions/1304237) via `about:config`, otherwise you need to patch the app.

If the client still refuses to connect, then the app may employ certificate pinning, which means that the app actively performs certificate verification against a whitelist. To bypass this, you either need to:

- On a device rooted with magisk, install the [LSposed](https://github.com/LSPosed/LSPosed) module. Then install the [sslunpinning](https://github.com/Xposed-Modules-Repo/io.github.tehcneko.sslunpinning/releases) module
- You can use [apk-mitm](https://github.com/shroudedcode/apk-mitm) to rebuild a patched apk with pinning disabled
- If none of the above works, then the app may use custom pinning logic, in which case you will need to unpack, reverse engineer, and patch it

### 3.4.2 Certificate transparency

When decrypting a browser traffic, the browser may refuse to connect to websites giving you an error about certificate transparency. With [Certificate transparency](https://en.wikipedia.org/wiki/Certificate_Transparency), custom system CA are normally rejected. To fix this, you either need to:

- in some browsers, you can disable certificate transparency, e.g. in bromite via `chrome://flags`
- uninstall the PCAPdroid CA from the system store or simply temporary disable it from the Android security settings
- if the PCAPdroid system CA is installed via the `MagiskTrustUserCerts` plugin, then you can use *magisk hide* on the browser to make it see the PCAPdroid CA as a non-system CA

### 3.4.3 Traffic is still encrypted

Some apps, like Telegram and Whatsapp, use a custom encrypted protocol, different from TLS. Such protocols require the development of custom tools for the decryption, which are out of the scope of PCAPdroid.

Moreover, beware not to confuse *encrypted* protocols with *binary* protocols. Both HTTP and DNS are not encrypted, but HTTP is a *text* protocol whereas DNS is a *binary* protocol. This does not mean that DNS is encrypted! You just need a *parser* to convert the binary information into human-readable form.


## 3.5 Decrypting via an external mitmproxy

For better flexibility, e.g. to modify the traffic or use an upstream proxy, you can perform the TLS decryption on a third-party SOCKS5 proxy, possibly located into another device. Here is an example on how to configure `mitmproxy` for this.

On a PC, you can install `mitmproxy` by following the [official installation guide](https://docs.mitmproxy.org/stable/overview-installation). Both the Android device and the PC should be connected to the same network for this to work. As an alternative, you can install `mitmproxy` directly on the Android device in `termux`. After installing the `termux` app, open it and run the following commands:

```bash
pkg update
pkg install python openssl-1.1-static
python3 -m pip install --upgrade pip

CRYPTOGRAPHY_DONT_BUILD_RUST=1 CRYPTOGRAPHY_SUPPRESS_LINK_FLAGS=1 \
  LDFLAGS="$PREFIX/lib/openssl-1.1/libssl.a $PREFIX/lib/openssl-1.1/libcrypto.a" \
  CFLAGS="-I$PREFIX/include/openssl-1.1" \
  pip install mitmproxy==7.0.4
```

This installs `mitmproxy` 7.0.4, which is the latest version to not require `rust`. If you want to install version 8+, refer [to these instructions](https://t.me/PCAPdroid/10071).

**Note**: when installed on the Android device via termux, it's essential to set an app filter in PCAPdroid to only capture a specific app traffic, otherwise the termux mitmproxy traffic would run in a loop, breaking the phone internet connectivity.

After installing `mitmproxy`, you need to perform the following steps:

1. Run `mitmproxy` without options to generate the mitm certificate. Install the certificate (usually `~/.mitmproxy/mitmproxy-ca-cert.cer`) in the Android phone. It may be needed to change the extension to `.crt` to install it
2. Open the PCAPdroid settings
3. Toggle "Enable SOCKS5 Proxy"
4. Set the IP address and port of the remote mitmproxy instance (port 8050 in this example)
5. Run mitmproxy in SOCKS5 mode, e.g. via `mitmproxy --mode socks5 --listen-port 8050`

PCAPdroid will now redirect all the TCP traffic to the mitmproxy server, which will proxy the connections and decrypt the TLS traffic. Please note that the PCAP generated by PCAPdroid will still contain the encrypted traffic with the original IP destinations and ports.
